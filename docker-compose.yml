version: "3.8"

services:
  traefik:
    image: traefik:v2
    container_name: traefik
    restart: unless-stopped
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.buckets=0.1,0.3,1.2,5.0"
      - "--log.level=ERROR"
      - "--accesslog=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.myresolver.acme.email=jameskefaslungu@gmail.com"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - traefik_letsencrypt:/letsencrypt
    networks:
      - web

  frontend:
    build:
      context: ./frontend
    environment:
      - VITE_AUTH_API_URL=https://kefaslungu.name.ng/api/auth
      - VITE_TODOS_API_URL=https://kefaslungu.name.ng/api/todos
      - VITE_USERS_API_URL=https://kefaslungu.name.ng/api/users
    depends_on:
      - auth-api
      - todos-api
      - users-api
    labels:
      - "traefik.enable=true"

      # HTTP redirect â†’ HTTPS
      - "traefik.http.routers.frontend-http.entrypoints=web"
      - "traefik.http.routers.frontend-http.rule=Host(`kefaslungu.name.ng`)"
      - "traefik.http.routers.frontend-http.middlewares=frontend-redirect"
      - "traefik.http.middlewares.frontend-redirect.redirectScheme.scheme=https"
      - "traefik.http.middlewares.frontend-redirect.redirectScheme.permanent=true"

      # HTTPS router
      - "traefik.http.routers.frontend-https.entrypoints=websecure"
      - "traefik.http.routers.frontend-https.rule=Host(`kefaslungu.name.ng`)"
      - "traefik.http.routers.frontend-https.tls.certresolver=myresolver"

    networks:
      - web

  auth-api:
    build:
      context: ./auth-api
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - USERS_API_ADDRESS=http://users-api:8083
    depends_on:
      - users-api
    labels:
      - "traefik.enable=true"

      # /api/auth route
      - "traefik.http.routers.authapi.entrypoints=websecure"
      - "traefik.http.routers.authapi.rule=Host(`kefaslungu.name.ng`) && PathPrefix(`/api/auth`)"
      - "traefik.http.routers.authapi.tls.certresolver=myresolver"
      - "traefik.http.services.authapi.loadbalancer.server.port=8081"
      - "traefik.http.middlewares.authapi-strip.stripprefix.prefixes=/api/auth"
      - "traefik.http.routers.authapi.middlewares=authapi-strip"

    networks:
      - web

  todos-api:
    build:
      context: ./todos-api
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - REDIS_HOST=redis-queue
      - REDIS_PORT=6379
      - REDIS_CHANNEL=log_channel
    depends_on:
      - redis-queue
    labels:
      - "traefik.enable=true"

      # /api/todos route
      - "traefik.http.routers.todosapi.entrypoints=websecure"
      - "traefik.http.routers.todosapi.rule=Host(`kefaslungu.name.ng`) && PathPrefix(`/api/todos`)"
      - "traefik.http.routers.todosapi.tls.certresolver=myresolver"
      - "traefik.http.services.todosapi.loadbalancer.server.port=8082"
      - "traefik.http.middlewares.todosapi-strip.stripprefix.prefixes=/api/todos"
      - "traefik.http.routers.todosapi.middlewares=todosapi-strip"

    networks:
      - web

  users-api:
    build:
      context: ./users-api
    environment:
      - JWT_SECRET=${JWT_SECRET}
    labels:
      - "traefik.enable=true"

      # /api/users route
      - "traefik.http.routers.usersapi.entrypoints=websecure"
      - "traefik.http.routers.usersapi.rule=Host(`kefaslungu.name.ng`) && PathPrefix(`/api/users`)"
      - "traefik.http.routers.usersapi.tls.certresolver=myresolver"
      - "traefik.http.services.usersapi.loadbalancer.server.port=8083"
      - "traefik.http.middlewares.usersapi-strip.stripprefix.prefixes=/api/users"
      - "traefik.http.routers.usersapi.middlewares=usersapi-strip"

    networks:
      - web

  log-processor:
    build:
      context: ./log-message-processor
    environment:
      - REDIS_HOST=redis-queue
      - REDIS_PORT=6379
      - REDIS_CHANNEL=log_channel
    depends_on:
      - redis-queue
    networks:
      - web

  redis-queue:
    image: redis:7
    volumes:
      - redis_data:/data
    networks:
      - web

volumes:
  traefik_letsencrypt:
  redis_data:

networks:
  web:
    external: true
