# .github/workflows/infrastructure.yml
name: Infrastructure Pipeline with Drift Detection

on:
  push:
    branches: [main, master]
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
  pull_request:
    branches: [main, master]
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
  workflow_dispatch:

env:
  TF_VERSION: '1.6.0'
  ANSIBLE_VERSION: '2.15'
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

jobs:
  terraform-plan:
    name: Terraform Plan & Drift Detection
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.drift.outputs.drift_detected }}
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Terraform Init
        working-directory: ./infra/terraform
        run: terraform init

      - name: Terraform Validate
        working-directory: ./infra/terraform
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: ./infra/terraform
        run: |
          terraform plan -detailed-exitcode -out=tfplan || echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Detect Drift
        id: drift
        working-directory: ./infra/terraform
        run: |
          EXITCODE=${{ steps.plan.outputs.exitcode }}
          if [ "$EXITCODE" == "2" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è DRIFT DETECTED - Infrastructure changes required"
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No drift detected - Infrastructure is in sync"
          fi

      - name: Save Plan
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: infra/terraform/tfplan
          retention-days: 5

  send-drift-notification:
    name: Send Drift Alert Email
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: needs.terraform-plan.outputs.drift_detected == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.ADMIN_EMAIL}}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ö†Ô∏è Azure Infrastructure Drift Detected - Approval Required"
          to: ${{ secrets.ADMIN_EMAIL}}
          from: DevOps Pipeline <${{ secrets.ADMIN_EMAIL}}>
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%); color: white; padding: 20px; border-radius: 5px; }
                .header.warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
                .content { background: #f4f4f4; padding: 20px; margin: 20px 0; border-radius: 5px; }
                .footer { text-align: center; color: #666; margin-top: 20px; }
                .btn { 
                  display: inline-block; 
                  padding: 10px 20px; 
                  background: #0078d4; 
                  color: white; 
                  text-decoration: none; 
                  border-radius: 5px; 
                  margin: 10px 0;
                }
                .warning { color: #ff6b6b; font-weight: bold; }
                .azure-icon { color: #0078d4; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header warning">
                  <h2>üö® Azure Infrastructure Drift Detected</h2>
                </div>
                <div class="content">
                  <p><strong>‚òÅÔ∏è Cloud Provider:</strong> Microsoft Azure</p>
                  <p><strong>Repository:</strong> ${{ github.repository }}</p>
                  <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
                  <p><strong>Commit:</strong> ${{ github.sha }}</p>
                  <p><strong>Author:</strong> ${{ github.actor }}</p>
                  <p><strong>Workflow:</strong> ${{ github.workflow }}</p>
                  
                  <hr>
                  
                  <p class="warning">‚ö†Ô∏è Infrastructure changes have been detected and require approval.</p>
                  
                  <p>Terraform has identified drift or changes in your Azure infrastructure that need to be applied.</p>
                  
                  <h3>Next Steps:</h3>
                  <ol>
                    <li>Review the changes in the GitHub Actions workflow</li>
                    <li>Verify changes in Azure Portal if needed</li>
                    <li>Approve the deployment if changes are expected</li>
                    <li>Investigate if changes are unexpected</li>
                  </ol>
                  
                  <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="btn">
                    View Workflow Run
                  </a>
                </div>
                <div class="footer">
                  <p>This is an automated notification from your DevOps pipeline.</p>
                  <p><small>Run ID: ${{ github.run_id }}</small></p>
                </div>
              </div>
            </body>
            </html>

  wait-for-approval:
    name: Wait for Manual Approval
    runs-on: ubuntu-latest
    needs: [terraform-plan, send-drift-notification]
    if: needs.terraform-plan.outputs.drift_detected == 'true'
    environment: 
      name: production-approval
    
    steps:
      - name: Approval Checkpoint
        run: |
          echo "‚úÖ Manual approval received"
          echo "Proceeding with terraform apply..."

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan, wait-for-approval]
    if: |
      always() &&
      (needs.terraform-plan.outputs.drift_detected == 'false' ||
       needs.wait-for-approval.result == 'success')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Terraform Init
        working-directory: ./infra/terraform
        run: terraform init

      - name: Download Plan
        if: needs.terraform-plan.outputs.drift_detected == 'true'
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: infra/terraform/

      - name: Terraform Apply
        working-directory: ./infra/terraform
        run: |
          if [ -f tfplan ]; then
            terraform apply tfplan
          else
            terraform apply -auto-approve
          fi

      - name: Save Inventory
        uses: actions/upload-artifact@v4
        with:
          name: ansible-inventory
          path: infra/ansible/inventory.ini
          retention-days: 1

  ansible-deploy:
    name: Ansible Deployment
    runs-on: ubuntu-latest
    needs: terraform-apply
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Inventory
        uses: actions/download-artifact@v4
        with:
          name: ansible-inventory
          path: infra/ansible/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          ansible-galaxy collection install community.docker

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_CONTENT}}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $(cat infra/ansible/inventory.ini | grep -oP '(?<=ansible_host=)[^ ]+') >> ~/.ssh/known_hosts

      - name: Run Ansible Playbook
        working-directory: ./infra/ansible
        run: |
          ansible-playbook -i inventory.ini playbook.yml
